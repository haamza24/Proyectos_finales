
;Para el enunciado,leer el pdf "PIC - LAB 3 - Interrupciones - II" adjunto


	LIST P= 16F876A
	include "p16f876a.inc"
__CONFIG _XT_OSC & _WDT_OFF & _LVP_OFF

	CONTADOR 			EQU 0X20
	SIGUIENTE_ESTADO 	EQU 0X21
	SPEED				EQU 0X22
	exPortb				EQU	0X23
	resXor				EQU 0X24
	INIT				EQU	0X25



org 0
goto inicio
org 4
goto ISR
org 5

inicio:

BSF STATUS,		RP0
BSF	TRISB,		RB7
BSF	TRISB,		RB6
BSF	TRISB,		RB0
CLRF TRISC
CLRF TRISA
BCF	ADCON1,PCFG3
BSF	ADCON1,PCFG2
BSF	ADCON1,PCFG1
BCF	ADCON1,PCFG0
BCF	OPTION_REG,	T0CS
BCF	OPTION_REG,	PSA
BSF	OPTION_REG,	PS2
BCF	OPTION_REG,	PS1
BSF	OPTION_REG,	PS0
BSF	OPTION_REG,	INTEDG
BSF	INTCON,		T0IE ;TMR0		INTERRUPCION	
BSF	INTCON,		RBIE ;RB6,RB7 	INTERRUPCION
BSF INTCON,		INTE ;RB0 		INTERRUCPION
BCF STATUS,		RP0
MOVF PORTB,0
MOVWF exPortb
BSF	INTCON,		GIE
	CALL	meteValores
	MOVLW	.5
	MOVWF	SPEED
	MOVF	SPEED,0
	MOVWF	PORTA
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
MOVLW	.22
MOVWF	TMR0

	MOVLW	b'1100'
	MOVWF	PORTC
	MOVLW 	b'0010'
	MOVWF	SIGUIENTE_ESTADO






main
	goto main


ISR:
	BTFSC INTCON,T0IF
	GOTO	ISR_TMR0
	GOTO	ISR_INTERRUPCION


ISR_TMR0:
		BCF	INTCON,T0IF
		DECFSZ CONTADOR,1
	GOTO		RECARGAR_TMR0
	GOTO	CAMBIAR_ESTADO

RECARGAR_TMR0:
	MOVLW .22
	MOVWF TMR0
	RETFIE


CAMBIAR_ESTADO:
	BTFSS SIGUIENTE_ESTADO,0
	GOTO	ESTADO_2_3_4
	GOTO	ESTADO_1

ESTADO_2_3_4:
	BTFSS	SIGUIENTE_ESTADO,1
	GOTO	ESTADO_3_4
	GOTO	ESTADO_2

ESTADO_3_4:
	BTFSS SIGUIENTE_ESTADO,2
	GOTO	ESTADO_4
	GOTO	ESTADO_3



ESTADO_1:

	MOVLW	b'1100'
	MOVWF	PORTC
	MOVLW 	b'0010'
	MOVWF	SIGUIENTE_ESTADO
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE


ESTADO_2:
	MOVLW	b'0110'
	MOVWF 	PORTC
	MOVLW	b'0100'
	MOVWF	 SIGUIENTE_ESTADO
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE


ESTADO_3:
	MOVLW	b'0011'
	MOVWF 	PORTC
	MOVLW	b'1000'
	MOVWF	 SIGUIENTE_ESTADO
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE
		


ESTADO_4:
	MOVLW	b'1001'
	MOVWF 	PORTC
	MOVLW	b'0001'
	MOVWF	 SIGUIENTE_ESTADO
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE
		




ISR_INTERRUPCION: 
	
	btfsc	 INTCON,RBIF
		GOTO INTERRUPCION_RB6_RB7
		GOTO INTERRUPCION_RB0
INTERRUPCION_RB6_RB7:
;TENGO QUE VER QUE INTERRUCOION HA SALTADO,RECUERDA LEER ANTES DE LIMPIAR

	MOVF PORTB,0
	BCF	 INTCON,RBIF
	XORWF	exPortb,0
	MOVWF	resXor
	MOVF	PORTB,0
	MOVWF	exPortb


BTFSC	resXor,6
	goto interrupcion_6
	goto interrupcion_7




interrupcion_6:

		BTFSC	PORTB,6 ;VEAMOS SI ES PRESSED=> 1->0
		RETFIE
		GOTO	decrementar_Velocidad




interrupcion_7:
		BTFSC	PORTB,7
		RETFIE
		GOTO	incrementar_Velocidad
		
		
	

incrementar_Velocidad:
	MOVLW .10
	SUBWF	SPEED,0
	BTFSC	STATUS,Z
	GOTO	LIMITAR_SPEED
	INCFSZ SPEED,1
	MOVF	SPEED,0
	MOVWF	PORTA
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE

LIMITAR_SPEED:
	MOVLW 	.10
	MOVWF	SPEED
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE	



decrementar_Velocidad:
	MOVLW	.1
	SUBWF	SPEED,0
	BTFSC	STATUS,Z ;VEO SI NO HA DADO 0 LA RESTA ANTERIOR
	GOTO	LIMITAR_SPEED_DOWN 
	DECFSZ SPEED,1
	MOVF	SPEED,0
	MOVWF	PORTA
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE
	

LIMITAR_SPEED_DOWN:

	MOVLW 	.1
	MOVWF	SPEED
	MOVF	SPEED,0
	ADDLW	0X30
	MOVWF	FSR
	MOVF	INDF,0
	MOVWF	CONTADOR
	RETFIE
		

INTERRUPCION_RB0: ; CADA VEZ QUE EL RB0 ES SOLTADO,SE CAMBIA AL SIGUIENTE ESTADO, DA IGUAL QUE EL TMR0 SIGA CORRIENDO, NOSOTROS SWITCHEAMOS DE ESTADO
	
	BCF		INTCON,INTF
	BSF		INIT,0
	
	RETFIE
					





meteValores:

movlw .1
movwf 0x3A


movlw .2
movwf 0x39

movlw .3
movwf 0x38


movlw .4
movwf 0x37


movlw .7
movwf 0x36


movlw .10
movwf 0x35


movlw .20
movwf 0x34

movlw .32
movwf 0x33


movlw .50
movwf 0x32


movlw .77
movwf 0x31


return

		
END

